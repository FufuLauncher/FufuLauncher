<Page
    x:Class="FufuLauncher.Views.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:helpers="using:FufuLauncher.Helpers"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    x:Name="MainPageRoot"
    Background="Transparent"
    Loaded="Page_Loaded"
    mc:Ignorable="d">

    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <XamlControlsResources xmlns="using:Microsoft.UI.Xaml.Controls" />
            </ResourceDictionary.MergedDictionaries>

            <ResourceDictionary.ThemeDictionaries>
                <ResourceDictionary x:Key="Light">
                    <SolidColorBrush x:Key="CustomPanelBackgroundBrush" 
                                     Color="{ThemeResource CardBackgroundFillColorDefault}"/>
                    <AcrylicBrush x:Key="IosGlassBrush" 
                                  TintColor="#FFFFFF" 
                                  TintOpacity="0.1" 
                                  FallbackColor="#CC000000"/>
                </ResourceDictionary>

                <ResourceDictionary x:Key="Default">
                    <SolidColorBrush x:Key="CustomPanelBackgroundBrush" 
                                     Color="#D9101010"/>
                    <AcrylicBrush x:Key="IosGlassBrush" 
                                  TintColor="#000000" 
                                  TintOpacity="0.15" 
                                  FallbackColor="#CC000000"/>
                </ResourceDictionary>
            </ResourceDictionary.ThemeDictionaries>

            <Storyboard x:Name="EntranceStoryboard">
                <DoubleAnimation Storyboard.TargetName="RootLayoutGrid"
                                 Storyboard.TargetProperty="Opacity"
                                 From="0" To="1" Duration="0:0:0.6">
                    <DoubleAnimation.EasingFunction>
                        <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
                <DoubleAnimation Storyboard.TargetName="RootLayoutScale"
                                 Storyboard.TargetProperty="ScaleX"
                                 From="0.9" To="1" Duration="0:0:0.6">
                    <DoubleAnimation.EasingFunction>
                        <BackEase EasingMode="EaseOut" Amplitude="0.3"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
                <DoubleAnimation Storyboard.TargetName="RootLayoutScale"
                                 Storyboard.TargetProperty="ScaleY"
                                 From="0.9" To="1" Duration="0:0:0.6">
                    <DoubleAnimation.EasingFunction>
                        <BackEase EasingMode="EaseOut" Amplitude="0.3"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>

            <helpers:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
            <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <helpers:BoolToGlyphConverter x:Key="BoolToGlyphConverter"/>
            
            <DataTemplate x:Key="NewsItemTemplate">
                <Button Background="Transparent" BorderThickness="0" Padding="8,2" Margin="0,1"
                        HorizontalAlignment="Stretch" 
                        HorizontalContentAlignment="Left" CornerRadius="4"
                        Command="{Binding ElementName=MainPageRoot, Path=OpenLinkCommand}"
                        CommandParameter="{Binding Link}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="{Binding Title}" FontSize="13" 
                                   Foreground="White"
                                   TextTrimming="CharacterEllipsis" MaxLines="1" Margin="0,0,8,0"/>
                        <TextBlock Grid.Column="1" Text="{Binding Date}" FontSize="12" 
                                   Foreground="White" Opacity="0.5" 
                                   VerticalAlignment="Center"/>
                    </Grid>
                </Button>
            </DataTemplate>
        </ResourceDictionary>
    </Page.Resources>

    <Grid x:Name="RootLayoutGrid" Opacity="0" RenderTransformOrigin="0.5,0.5">
        <Grid.RenderTransform>
            <ScaleTransform x:Name="RootLayoutScale" ScaleX="1" ScaleY="1"/>
        </Grid.RenderTransform>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="360"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <StackPanel Grid.Column="0" 
                        Margin="24,0,0,32"
                        VerticalAlignment="Bottom"
                        Spacing="12">
                
                <Grid CornerRadius="12"
                      BorderThickness="1"
                      BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                      Background="{StaticResource IosGlassBrush}"
                      Height="{Binding InfoCardHeight, Mode=OneWay}"
                      PointerEntered="InfoCard_PointerEntered"
                      PointerExited="InfoCard_PointerExited"
                      x:Name="InfoCardGrid"
                      Translation="0,0,48">
                    
                    <Grid.Shadow>
                        <ThemeShadow />
                    </Grid.Shadow>
                      
                    <Grid.RowDefinitions>
                        <RowDefinition Height="135"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Margin="0" CornerRadius="12,12,0,0" Background="#20000000">
                        <FlipView ItemsSource="{x:Bind ViewModel.Banners, Mode=OneWay}"
                                  SelectedItem="{x:Bind ViewModel.CurrentBanner, Mode=TwoWay}">
                            <FlipView.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Image Source="{Binding Image.Url}" 
                                               Stretch="UniformToFill" 
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"
                                               RenderTransformOrigin="0.5,0.5">
                                            <Image.RenderTransform>
                                                <ScaleTransform ScaleX="1.005" ScaleY="1.005"/>
                                            </Image.RenderTransform>
                                        </Image>
                                        <Button Background="Transparent"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                Command="{Binding ElementName=MainPageRoot, Path=OpenLinkCommand}"
                                                CommandParameter="{Binding Image.Link}"/>
                                    </Grid>
                                </DataTemplate>
                            </FlipView.ItemTemplate>
                        </FlipView>
                        
                        <Button x:Name="InfoExpandButton"
                                VerticalAlignment="Bottom" HorizontalAlignment="Right"
                                Margin="0,0,8,8"
                                Background="#99000000"
                                BorderThickness="0"
                                CornerRadius="4" 
                                Padding="6,2"
                                Opacity="0"
                                IsHitTestVisible="True"
                                Command="{Binding ToggleInfoCardCommand}">
                            <FontIcon Glyph="{x:Bind ViewModel.InfoExpandIcon, Mode=OneWay}" 
                                      FontSize="10" Foreground="White"/>
                        </Button>
                    </Grid>

                    <Pivot Grid.Row="1" Margin="2,0,2,2">
                        <Pivot.Resources>
                            <SolidColorBrush x:Key="PivotHeaderItemForeground" Color="White" />
                            <SolidColorBrush x:Key="PivotHeaderItemForegroundSelected" Color="White" />
                            <SolidColorBrush x:Key="PivotHeaderItemForegroundPointerOver" Color="White" />
                            <SolidColorBrush x:Key="PivotHeaderItemForegroundPressed" Color="White" />
                            
                            <Style TargetType="PivotHeaderItem">
                                <Setter Property="FontSize" Value="13"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Margin" Value="0"/>
                                <Setter Property="Padding" Value="12,0"/>
                                <Setter Property="MinHeight" Value="32"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Style>
                        </Pivot.Resources>

                        <PivotItem Header="活动">
                            <ListView ItemsSource="{x:Bind ViewModel.ActivityPosts}"
                                      ItemTemplate="{StaticResource NewsItemTemplate}"
                                      SelectionMode="None"
                                      Padding="4,0,4,4">
                            </ListView>
                        </PivotItem>

                        <PivotItem Header="公告">
                            <ListView ItemsSource="{x:Bind ViewModel.AnnouncementPosts}"
                                      ItemTemplate="{StaticResource NewsItemTemplate}"
                                      SelectionMode="None"
                                      Padding="4,0,4,4">
                            </ListView>
                        </PivotItem>

                        <PivotItem Header="资讯">
                            <ListView ItemsSource="{x:Bind ViewModel.InfoPosts}"
                                      ItemTemplate="{StaticResource NewsItemTemplate}"
                                      SelectionMode="None"
                                      Padding="4,0,4,4">
                            </ListView>
                        </PivotItem>
                    </Pivot>
                </Grid>
 
                <Grid Padding="16" CornerRadius="8" 
                      BorderThickness="1" 
                      BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                      Background="{StaticResource IosGlassBrush}"
                      Translation="0,0,48">
                    
                    <Grid.Shadow>
                        <ThemeShadow />
                    </Grid.Shadow>

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Text="原神签到" FontSize="15" FontWeight="SemiBold" 
                               Foreground="White"
                               Margin="0,0,0,8" Opacity="0.9"/>
                    
                    <StackPanel Grid.Row="1" Spacing="2" Margin="0,0,0,12">
                        <TextBlock Text="{Binding CheckinStatusText}" FontSize="13" TextWrapping="Wrap" Foreground="White"/>
                        <TextBlock Text="{Binding CheckinSummary}" FontSize="11" 
                                   Foreground="White"
                                   Opacity="0.6" TextWrapping="Wrap"/>
                    </StackPanel>
                    
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>    <ColumnDefinition Width="Auto"/> <ColumnDefinition Width="Auto"/> </Grid.ColumnDefinitions>

                        <Button Grid.Column="0" 
                                Content="{Binding CheckinButtonText}"
                                Command="{Binding ExecuteCheckinCommand}"
                                IsEnabled="{Binding IsCheckinButtonEnabled, Mode=OneWay}"
                                HorizontalAlignment="Stretch" 
                                CornerRadius="4" 
                                Padding="12,6"
                                Margin="0,0,8,0"
                                Style="{StaticResource AccentButtonStyle}"/>

                        <Border Grid.Column="1"
                                Margin="0,0,8,0" 
                                Width="32" Height="32" 
                                Background="#1AFFFFFF" 
                                CornerRadius="4">
                            <TextBlock Text="{x:Bind ViewModel.CurrentDayText}" 
                                       FontSize="13" 
                                       FontWeight="Bold" 
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>

                        <Border Grid.Column="2" 
                                Width="32" Height="32" 
                                Background="#1AFFFFFF" 
                                CornerRadius="4">
                            <FontIcon Glyph="{Binding CheckinStateGlyph, Mode=OneWay}" 
                                      FontSize="16" 
                                      Foreground="{Binding CheckinStateBrush, Mode=OneWay}"/>
                        </Border>
                    </Grid>
                </Grid>
            </StackPanel>
            
            <TextBlock Grid.Column="0"
                       Text="© 2026 FufuLauncher Development Team.All Rights Reserved."
                       FontSize="10"
                       Foreground="White"
                       Opacity="0.05"
                       VerticalAlignment="Bottom"
                       HorizontalAlignment="Left"
                       Margin="30,0,0,10"
                       PointerEntered="Copyright_PointerEntered"
                       PointerExited="Copyright_PointerExited"
                       x:Name="CopyrightText"
                       IsHitTestVisible="True"/>
            
            <Grid Grid.Column="1"
                  VerticalAlignment="Top" HorizontalAlignment="Right" 
                  Margin="0,32,32,0"
                  Background="Transparent"
                  PointerEntered="BackgroundButton_PointerEntered"
                  PointerExited="BackgroundButton_PointerExited">
                
                <Button Command="{x:Bind ViewModel.ToggleBackgroundTypeCommand}"
                        IsEnabled="True" 
                        CornerRadius="24" 
                        Padding="0"
                        Background="Transparent"
                        BorderThickness="0"
                        Margin="0">
                    <Grid x:Name="BackgroundToggleGrid" Opacity="0.0">
                        <Border x:Name="BackgroundBlurBorder"
                                Background="{StaticResource IosGlassBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="24">
                        </Border>

                        <StackPanel Orientation="Horizontal" Margin="18,12">
                            <TextBlock Text="{x:Bind ViewModel.BackgroundTypeToggleText, Mode=OneWay}"
                                       Foreground="White"
                                       FontSize="14" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Grid>
                </Button>
            </Grid>

            <Button Grid.Row="1" Grid.Column="1"
                    Command="{Binding OpenScreenshotFolderCommand}"
                    IsEnabled="{Binding ViewModel.IsLaunchButtonEnabled, Mode=OneWay}"
                    HorizontalAlignment="Right" VerticalAlignment="Bottom"
                    Margin="0,0,280,32" CornerRadius="24" Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    PointerEntered="ScreenshotButton_PointerEntered"
                    PointerExited="ScreenshotButton_PointerExited"
                    Translation="0,0,0">
                
                <Button.Shadow>
                    <ThemeShadow />
                </Button.Shadow>

                <Grid>
                    <Border x:Name="ScreenshotBlurBorder"
                            Background="{StaticResource IosGlassBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="24"
                            Opacity="1.0">
                    </Border>

                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="18,12">
                        <FontIcon Glyph="&#xE8B7;" FontSize="16" Foreground="White"/>
                        <TextBlock Text="截图文件夹" FontSize="14" FontWeight="SemiBold" Foreground="White"/>
                    </StackPanel>
                </Grid>
            </Button>
            
            <Button Grid.Row="1" Grid.Column="1"
                    Command="{x:Bind ViewModel.LaunchGameCommand}"
                    IsEnabled="{x:Bind ViewModel.IsLaunchButtonEnabled, Mode=OneWay}"
                    HorizontalAlignment="Right" VerticalAlignment="Bottom"
                    Margin="0,0,32,32" 
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    CornerRadius="24"
                    Translation="0,0,48">
                 
                <Button.ContextFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="切换到 Bilibili 服" Click="SwitchToBilibili_Click" Icon="Switch" />
                        <MenuFlyoutItem Text="切换到 官方服务器" Click="SwitchToOfficial_Click" Icon="Switch" />
                    </MenuFlyout>
                </Button.ContextFlyout>
                
                <Button.Shadow>
                    <ThemeShadow /> 
                </Button.Shadow>
                
                <Grid>
                    <Border Background="{StaticResource IosGlassBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="24"/>

                    <Border x:Name="LaunchButtonOverlayBorder" CornerRadius="24">
                        <Border.Background>
                            <SolidColorBrush Color="#0078D7" Opacity="0.4"/>
                        </Border.Background>
                    </Border>

                    <StackPanel Orientation="Horizontal" Spacing="12" Padding="36,18">
                        <ProgressRing Width="20" Height="20"
                                      IsActive="{x:Bind ViewModel.IsGameLaunching, Mode=OneWay}"
                                      Visibility="{x:Bind ViewModel.IsGameLaunching, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
        
                        <FontIcon Glyph="{x:Bind ViewModel.LaunchButtonIcon, Mode=OneWay}" 
                                  FontSize="20" Foreground="White"/>
        
                        <TextBlock Text="{x:Bind ViewModel.LaunchButtonText, Mode=OneWay}"
                                   Foreground="White"
                                   FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Button>
        </Grid>
    </Grid>
</Page>